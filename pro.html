<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YAKUtime Pro - 管理設定</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #f8fafc; font-family: sans-serif; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-black text-slate-800">YAKUtime <span class="text-blue-600">Pro</span></h1>
                <p class="text-slate-500 font-bold text-sm">薬局バックヤード管理システム</p>
            </div>
            <div id="auth-status" class="bg-blue-50 text-blue-600 px-4 py-2 rounded-full text-xs font-bold">
                接続確認中...
            </div>
        </header>

        <!-- タブ切り替え -->
        <div class="flex border-b border-slate-200 mb-6 bg-white rounded-t-xl">
            <button onclick="switchTab('settings')" id="tab-settings" class="flex-1 py-4 font-bold tab-active transition-all">店舗設定</button>
            <button onclick="switchTab('demo')" id="tab-demo" class="flex-1 py-4 font-bold text-slate-400 transition-all">データ操作</button>
        </div>

        <!-- 店舗設定コンテンツ -->
        <div id="content-settings" class="bg-white p-6 rounded-b-xl shadow-sm space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-2">
                    <label class="text-sm font-bold text-slate-700 italic">Shop ID (半角英数字)</label>
                    <input type="text" id="shop-id" value="shibuya-001" class="w-full p-3 border rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-bold text-slate-700 italic">店舗名</label>
                    <input type="text" id="shop-name" value="渋谷センター薬局" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-bold text-slate-700 italic">緯度 (Latitude)</label>
                    <input type="number" id="shop-lat" value="35.6600" step="0.0001" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-bold text-slate-700 italic">経度 (Longitude)</label>
                    <input type="number" id="shop-lng" value="139.7000" step="0.0001" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>
            <button id="btn-save" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-4 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2">
                <i data-lucide="save" class="w-5 h-5"></i>
                設定を保存してFirestoreを実体化
            </button>
        </div>

        <!-- データ操作コンテンツ -->
        <div id="content-demo" class="hidden bg-white p-6 rounded-b-xl shadow-sm space-y-6">
            <div class="p-4 bg-amber-50 rounded-lg border border-amber-200">
                <p class="text-amber-700 text-sm font-bold">※デモボタンを押すと、3つのサンプル店舗データがFirestoreに一括登録されます。</p>
            </div>
            <button id="btn-demo" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-black py-4 rounded-xl shadow-lg transition-all">
                デモ用サンプルデータを一括作成
            </button>
        </div>

        <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-2xl font-bold shadow-2xl opacity-0 transition-opacity pointer-events-none">
            保存完了しました！
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjSZkIuGQ4oRoMcZYLaZbdBXK45cBBXos",
            authDomain: "yakutime-for-ipad.firebaseapp.com",
            projectId: "yakutime-for-ipad",
            storageBucket: "yakutime-for-ipad.firebasestorage.app",
            messagingSenderId: "732724570588",
            appId: "1:732724570588:web:6e64cba96c6fd17646c719"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'yakutime-for-ipad';

        lucide.createIcons();

        // タブ切り替え
        window.switchTab = (tab) => {
            const isSettings = tab === 'settings';
            document.getElementById('content-settings').classList.toggle('hidden', !isSettings);
            document.getElementById('content-demo').classList.toggle('hidden', isSettings);
            document.getElementById('tab-settings').className = isSettings ? 'flex-1 py-4 font-bold tab-active' : 'flex-1 py-4 font-bold text-slate-400';
            document.getElementById('tab-demo').className = !isSettings ? 'flex-1 py-4 font-bold tab-active' : 'flex-1 py-4 font-bold text-slate-400';
        };

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('opacity-0');
            setTimeout(() => t.classList.add('opacity-0'), 3000);
        }

        // 保存処理
        document.getElementById('btn-save').onclick = async () => {
            const sid = document.getElementById('shop-id').value;
            const sname = document.getElementById('shop-name').value;
            const slat = parseFloat(document.getElementById('shop-lat').value);
            const slng = parseFloat(document.getElementById('shop-lng').value);

            try {
                // 1. 親ドキュメントの実体化 (artifacts/yakutime-for-ipad)
                const parentRef = doc(db, 'artifacts', appId);
                await setDoc(parentRef, { 
                    lastUpdated: serverTimestamp(),
                    appName: "YAKUtime Maps"
                }, { merge: true });

                // 2. 店舗データの保存
                const shopRef = doc(db, 'artifacts', appId, 'public', 'data', 'shops', sid);
                await setDoc(shopRef, {
                    name: sname,
                    location: { lat: slat, lng: slng },
                    status: {
                        waiting: { count: 0, updatedAt: serverTimestamp() }
                    }
                });

                showToast("実体化・保存が完了しました！");
            } catch (e) {
                console.error(e);
                showToast("エラーが発生しました: " + e.message);
            }
        };

        // デモデータ一括作成
        document.getElementById('btn-demo').onclick = async () => {
            const batch = writeBatch(db);
            const shops = [
                { id: 'shibuya-001', name: '渋谷センター薬局', lat: 35.6601, lng: 139.7001, count: 1 },
                { id: 'shibuya-002', name: '渋谷ABC薬局', lat: 35.6620, lng: 139.7020, count: 4 },
                { id: 'shibuya-003', name: 'ヤクタイム薬局', lat: 35.6580, lng: 139.7015, count: 7 }
            ];

            try {
                // 親の実体化も忘れずに
                const parentRef = doc(db, 'artifacts', appId);
                batch.set(parentRef, { lastUpdated: serverTimestamp() }, { merge: true });

                shops.forEach(s => {
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'shops', s.id);
                    batch.set(ref, {
                        name: s.name,
                        location: { lat: s.lat, lng: s.lng },
                        status: {
                            waiting: { count: s.count, updatedAt: serverTimestamp() }
                        }
                    });
                });
                await batch.commit();
                showToast("3店舗のデモデータを作成しました！");
            } catch (e) {
                showToast("エラー: " + e.message);
            }
        };

        window.onload = async () => {
            onAuthStateChanged(auth, (user) => {
                if (user) document.getElementById('auth-status').innerText = "Firestore 接続済み";
            });
            await signInAnonymously(auth);
        };
    </script>
</body>
</html>
